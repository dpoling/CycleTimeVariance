<!DOCTYPE html>
<html>
<head>
    <title>CycleTimeVariance</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){this._createStore()},onTimeboxScopeChange:function(timeboxScope){this.getContext().setTimeboxScope(timeboxScope),this._removeGrid(),this._createStore()},_createStore:function(){Ext.create("Rally.data.wsapi.Store",{model:"userstory",autoLoad:!0,filters:this._getFilters(),limit:"Infinity",listeners:{load:this._onDataLoaded,scope:this},fetch:["FormattedID","Name","ScheduleState","Project","PlanEstimate","InProgressDate","AcceptedDate"]})},_onDataLoaded:function(store,data){var records=Ext.Array.map(data,function(record){var d1=Rally.util.DateTime.fromIsoString(record.get("InProgressDate")),d2=Rally.util.DateTime.fromIsoString(record.get("AcceptedDate")),days=this._calcDays(d1,d2);return Ext.apply({daysCount:days},record.getData())},this);this._addGrid(records)},_getFilters:function(){var tbScope=this.getContext().getTimeboxScope(),qFilter="(ScheduleState > Completed)";if(tbScope){var tbFilter=tbScope.getQueryFilter();return qFilter&&qFilter.length>0?tbFilter.and(Rally.data.wsapi.Filter.fromQueryString(qFilter)):tbFilter}return qFilter&&qFilter.length>0?Rally.data.wsapi.Filter.fromQueryString(qFilter):[]},_calcDays:function(d1,d2){d1=Rally.util.DateTime.convertForEditing(d1),d2=Rally.util.DateTime.convertForEditing(d2),0===d1.getDay()&&(d1=Rally.util.DateTime.add(d1,"day",-2),d1.setHours(18),d1.setMinutes(0)),6===d1.getDay()&&(d1=Rally.util.DateTime.add(d1,"day",-1),d1.setHours(18),d1.setMinutes(0)),0===d2.getDay()&&(d2=Rally.util.DateTime.add(d2,"day",-2),d2.setHours(18),d2.setMinutes(0)),6===d2.getDay()&&(d2=Rally.util.DateTime.add(d2,"day",-1),d2.setHours(18),d2.setMinutes(0)),d1.getHours()<8&&(d1.setHours(8),d1.setMinutes(0)),d2.getHours()>18&&(d2.setHours(18),d2.setMinutes(0));var days=this._getDifference(d2,d1);return days},_getDifference:function(d2,d1){var value=0,h1=d1.getHours(),m1=d1.getMinutes(),h2=d2.getHours(),m2=d2.getMinutes();value+=this._getStartFractionOrFull(h1,m1),value+=this._getLastFractionOrFull(h2,m2);var sd=Rally.util.DateTime.add(d1,"day",1);sd.setHours(8),sd.setMinutes(0);var ld=Rally.util.DateTime.add(d2,"day",-1);for(ld.setHours(18),ld.setMinutes(0);sd<=ld;)0===sd.getDay()||6===sd.getDay()||this._isHoliday(sd)||(value+=1),sd=Rally.util.DateTime.add(sd,"day",1);return value},_getStartFractionOrFull:function(hours,minutes){var value=0;return hours<10||10===hours&&minutes<=14?value=1:hours<11||11===hours&&minutes<=44?value=.75:hours<13||13===hours&&minutes<=44?value=.5:(hours<16||16===hours&&minutes<=44)&&(value=.25),value},_getLastFractionOrFull:function(hours,minutes){var value=0;return value=hours<10||10===hours&&minutes<=14?0:hours<11||11===hours&&minutes<=59?.25:hours<13||13===hours&&minutes<=44?.5:hours<16||16===hours&&minutes<=44?.75:1},_isHoliday:function(d){var result=!1,yr=d.getFullYear(),goodFriday=this._getEaster(yr);goodFriday=Rally.util.DateTime.add(goodFriday,"day",-2);var labourDay=this._getFirstMonday(9,yr);return 0===d.getMonth()&&1===d.getDate()?result=!0:d.getMonth()===goodFriday.getMonth()&&d.getDate()===goodFriday.getDate()?result=!0:6===d.getMonth()&&1===d.getDate()?result=!0:d.getMonth()===labourDay.getMonth()&&d.getDate()===labourDay.getDate()?result=!0:11===d.getMonth()&&25===d.getDate()&&(result=!0),result},_getEaster:function(y){var date,a,b,c,m,d;return date=new Date,date.setHours(0,0,0,0),date.setFullYear(y),a=y%19,b=2200<=y&&y<=2299?(11*a+4)%30:(11*a+5)%30,c=0===b||1===b&&a>10?b+1:b,m=1<=c&&c<=19?3:2,d=(50-c)%31,date.setMonth(m,d),date.setMonth(m,d+(7-date.getDay())),date},_getFirstMonday:function(month,year){var d=new Date;d.setHours(0,0,0,0),d.setFullYear(year),d.setMonth(month-1),d.setDate(1);var day=0;return 0===d.getDay()?(day=2,d=d.setDate(day),d=new Date(d)):1!==d.getDay()&&(day=9-d.getDay(),d=d.setDate(day),d=new Date(d)),d},_addGrid:function(records){this.add({xtype:"rallygrid",showPagingToolbar:!0,showRowActionsColumn:!1,editable:!1,features:[{ftype:"groupingsummary",groupHeaderTpl:"{name} ({rows.length})"}],store:Ext.create("Rally.data.custom.Store",{groupField:"Project",groupDir:"ASC",getGroupString:function(record){var proj=record.get("Project");return proj&&proj._refObjectName||"None"},data:records}),columnCfgs:[{xtype:"templatecolumn",text:"ID",dataIndex:"FormattedID",width:75,tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Name",dataIndex:"Name",flex:1},{text:"In-Progress Date",dataIndex:"InProgressDate",flex:1,renderer:function(value){if(value){var date=Rally.util.DateTime.fromIsoString(value);return Rally.util.DateTime.format(date,"D M d Y : h:i:s a")}return"-- No InProgress Date --"}},{text:"Accepted Date",dataIndex:"AcceptedDate",flex:1,renderer:function(value){if(value){var date=Rally.util.DateTime.fromIsoString(value);return Rally.util.DateTime.format(date,"D M d Y : h:i:s a")}return"-- No Accepted Date --"}},{text:"Plan Est",dataIndex:"PlanEstimate",width:40},{text:"Days",dataIndex:"daysCount",width:60,renderer:function(v,m,r){var p=r.get("PlanEstimate");return v>p?"<font color='red' font-weight='bold' background-color='lightgray'>"+v+"</font>":"<font color='green' font-weight='bold' background-color='lightgray'>"+v+"</font>"}}]})},_removeGrid:function(){var grid=this.down("rallygrid");grid&&this.remove(grid)}});

            Rally.launchApp('CustomApp', {
                name:"CycleTimeVariance",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
